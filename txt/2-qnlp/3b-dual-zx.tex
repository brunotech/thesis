%!TEX root = ../../THESIS.tex

\subsection{Differentiating the ZX-calculus}\label{2b-differentiating-zx}

This section applies the dual number construction to the diagrams of the ZX-calculus with smooth functions $\alpha : \R^n \to \R$ as phases.
For each number of variables $n \in \N$, we define $\mathbf{ZX}_n$ as the free symmetric category generated by the signature:
$$\Sigma_0 = \{ x \} \s \text{and} \s \Sigma_1 = \{ H : x \to x \} + \{ Z^{m, n}(\alpha) : x^{\otimes m} \to x^{\otimes n} \ \vert \ m, n \in \N, \alpha : \R^n \to \R \}$$
where $H$ is depicted as a yellow box and $Z^{m, n}(\alpha)$ as a green spider.
The red spider is syntactic sugar for a green spider with yellow boxes connected to each leg.
The interpretation $[\![-]\!]  : \mathbf{ZX}_n \to \mathbf{Mat}_\S$ in matrices over $\S = \R^n \to \C$ is given by on objects by $[\![ x ]\!] = 2$ and on arrows by
$[\![ H ]\!] = \frac{1}{\sqrt{2}} \big(\ket{0}\bra{0} + \ket{0}\bra{1} + \ket{1}\bra{0} - \ket{1}\bra{1}\big)$
and $[\![Z^{m, n}(\alpha)]\!] =
e^{-i \alpha / 2} \ket{0}^{\otimes n} \bra{0}^{\otimes m}
+ e^{i \alpha / 2} \ket{1}^{\otimes n} \bra{1}^{\otimes m}$.
Note that we've scaled the standard interpretation of the green spider by a global phase to match the usual definition of rotation gates in quantum circuits.
For $n = 0$ we get $\mathbf{ZX}_0 = \mathbf{ZX}$ the ZX-calculus with no parameters.
By currying, any ZX diagram $d \in \mathbf{ZX}_n$ can be seen as a function $d : \R^n \to \text{Ar}(\mathbf{ZX})$ such that $[\![-]\!] \circ d : \R^n \to \mathbf{Mat}_\C$ is smooth.

\begin{lemma}\label{lemma-scalars}
A function $s : \R^n \to \C$ can be drawn as a scalar diagram in $\mathbf{ZX}_n$ if and only if it is bounded.
\end{lemma}

\begin{proof}
Generalising \cite[P.~8.101]{CoeckeKissinger17} to parametrised scalars, if there is a $k \in \N$ with $\vert s(\theta) \vert \leq 2^k$ for all $\theta \in \R^n$ then there are parametrised phases $\alpha, \beta : \R^n \to \R$ such that

\ctikzfig{img/diag-diff/2-2-bounded-lemma}

In the other direction, take any scalar diagram $d$ in $\mathbf{ZX}_n$.
Let $k$ be the number of spider in the diagram and $l$ the maximum number
of legs. By decomposing each spider as a sum of two disconnected diagrams,
we can write $d$ as a sum of $2^k$ diagrams. Each term of the sum is a product
of at most $\frac{1}{2} \times k \times l$ bone-shaped scalars. Each bone is
bounded by $2$, thus $[\![d]\!] : \R^n \to \C$ is bounded by $2^{k \times l}$.
\end{proof}

\begin{lemma}\label{lemma-rotations}
In $\mathbf{ZX}_n$, we have $\tikzfig{img/diag-diff/2-3a-lemma-rotation}$
for all affine $\alpha : \R^n \to \R$.
\end{lemma}

\begin{proof}
Because $\alpha$ is affine we have that $\partial \alpha$ is constant, hence bounded and from lemma~\ref{lemma-scalars} we know it can be drawn in $\mathbf{ZX}_n$.
\begin{align*}
\partial [\![ Z(\alpha) ]\!]
&= \partial \big( e^{-i \alpha / 2} \ket{0}+ e^{i \alpha / 2} \ket{1}\big)\\
&= \frac{i\partial\alpha}{2}\big(-e^{-i \alpha / 2} \ket{0} + e^{i\alpha / 2} \ket{1}\big)\\
&= \frac{\partial\alpha}{2}\big(e^{-i\frac{\alpha+\pi}{2}} \ket{0} + e^{i\frac{\alpha+\pi}{2}} \ket{1}\big)
\end{align*}
\end{proof}

\begin{theorem}\label{theorem-zx-diag-diff}
The ZX-calculus with affine maps $\R^n \to \R$ as phases admits diagrammatic
differentiation.
\end{theorem}

\begin{proof}
The Hadamard $H$ has derivative zero.
For the green spiders, we can extend lemma~\ref{lemma-rotations} from
single qubit rotations to arbitrary many legs using spider fusion:
\ctikzfig{img/diag-diff/2-4-zx-theorem}
\end{proof}

Note that there is no diagrammatic differentiation for the ZX-calculus with
smooth maps as phases, even when restricted to bounded functions.
Take for example $\alpha : \R \to \R$ with $\alpha(\theta) = \sin \theta^2$,
it is smooth and bounded by $1$ but its derivative $\partial \alpha$ is
unbounded.
Thus, from lemma~\ref{lemma-scalars} we know it cannot be represented as a
scalar diagram in $\mathbf{ZX}_1$: there can be no diagrammatic
differentiation $\partial : \mathbf{ZX}_1 \to \D[\mathbf{ZX}_1]$.
In such cases, we can always extend the signature by adjoining a new box
for each derivative.

\begin{proposition}
For every interpretation $[\![-]\!] : C_\Sigma^+ \to \mathbf{Mat}_\S$,
there is an extended signature $\Sigma' \supset \Sigma$
and interpretation $[\![-]\!] : C_{\Sigma'}^+ \to \mathbf{Mat}_\S$
such that $C_{\Sigma'}^+$ admits digrammatic differentiation.
\end{proposition}

\begin{proof}
Let $\Sigma' = \cup_{n \in \N} \Sigma^n$ where $\Sigma^0 = \Sigma$
and $\Sigma^{n + 1} = \Sigma^n \cup \{ \partial f \ \vert \ f \in \Sigma^n \}$
with $[\![\partial f]\!] = \partial [\![f]\!]$.
\end{proof}

The issue of being able to represent arbitrary scalars disappears if we work
with the algebraic ZX-calculus instead. Furthermore, we can generalise
from $\S = \R^n \to \C$ to any commutative rig.
We define the category $\mathbf{ZX}_\S$ as the free symmetric category generated by the signature given in \cite[Table~2]{Wang20} and the interpretation $[\![-]\!] : \mathbf{ZX}_\S \to \mathbf{Mat}_\S$ given in \cite[ยง6]{Wang20}.
In particular, there is a green square $R_Z^{m, n}(a) \in \Sigma_1$ for each $a \in \S$ and $m, n \in \N$ with interpretation
$$[\![R_Z^{m, n}(a)]\!] = \ket{0}^{\otimes n} \bra{0}^{\otimes m} + a \ket{1}^{\otimes n} \bra{1}^{\otimes m}$$
Let $\mathbf{ZX}_\S^+$ be the category of formal sums of algebraic ZX
diagrams over $\S$.

\begin{theorem}
Diagrammatic derivations for the interpretation $[\![-]\!] : \mathbf{ZX}_\S^+ \to \mathbf{Mat}_\S$
are in one-to-one correspondance with rig derivations $\partial : \S \to \S$.
\end{theorem}

\begin{proof}
Given a derivation $\partial$ on $\S$, we have
$\partial [\![R_Z^{m, n}(a)]\!]
= (\partial a) \ket{1}^{\otimes n} \bra{1}^{\otimes m}$
and $\partial a$ can be represented by the scalar diagram
$R_Z^{1, 0}(\partial a) \ket{1}$.
In the other direction, a diagrammatic derivation $\partial$ on
$\mathbf{ZX}_\S^+$ is uniquely determined by its action on scalars
$R_Z^{1, 0}(a) \ket{1}$ for $a \in \S$.
\end{proof}

One application of diagrammatic differentiation is to solve
differential equations between diagrams. As a first step,
we apply Stone's theorem \cite{Stone32} on one-parameter unitary groups
to the ZX-calculus.

\begin{definition}
A one-parameter unitary group is a unitary matrix $U : n \to n$
in $\mathbf{Mat}_{\R \to \C}$ with $U(0) = \id_n$ and $U(\theta) U(\theta') = U(\theta + \theta')$
for all $\theta, \theta' \in \R$. It is strongly continuous when
$\lim_{\theta \to \theta_0} U(\theta) = U(\theta_0)$ for all $\theta_0 \in \R$.

We say a one-parameter diagram $d : x^{\otimes n} \to x^{\otimes n}$
is a unitary group if its interpretation $[\![d]\!]$ is.
\end{definition}

\begin{remark}
The interpretation of diagrams with smooth maps as phases are necessarily strongly continuous.
\end{remark}

\begin{theorem}[Stone]
There is a one-to-one correspondance between strongly continuous one-parameter
unitary groups $U : n \to n$ in $\mathbf{Mat}_{\R \to \C}$ and self-adjoint
matrices $H : n \to n$ in $\mathbf{Mat}_{\C}$. The bijection is given
explicitly by $U(\theta) = \exp(i \theta H)$ and $H = - i (\partial U)(0)$,
translated in terms of diagrams with bubbles we get:
\ctikzfig{img/diag-diff/2-5-stone-theorem}
\end{theorem}

\begin{corollary}
A one-parameter diagram $d : x^{\otimes n} \to x^{\otimes n}$ in
$\mathbf{ZX}_1$ is a unitary group iff there is a constant
self-adjoint diagram
$h : x^{\otimes n} \to x^{\otimes n}$ such that $\partial d = i h \fcmp d$.
\end{corollary}

\begin{proof}
Given the diagram for a unitary group $d$, we compute its diagrammatic
differentiation $\partial d$ and get $h$ by pattern matching.
Conversely given a self-adjoint $h$, the diagram $d = \exp(i \theta h)$
is a unitary group.
\end{proof}

\begin{example}
Let $d = R_z(\alpha) \otimes R_x(\alpha)$ for a smooth $\alpha : \R \to \R$, then the following implies $d(\theta) = \exp(i \theta h)$ for $h = - i \frac{\partial \alpha}{2}(Z \otimes I + I \otimes X)$.
\ctikzfig{img/diag-diff/2-6-simple-example}
\end{example}

\begin{example}
Let $d = P(\alpha, ZX)$ be a Pauli gadget as in \cite[Definition~4.1]{CowtanEtAl20a} then
the following implies
$d(\theta) = \exp(i \theta h)$ for $h = -i \frac{\partial \alpha}{2} Z \otimes X$.
\ctikzfig{img/diag-diff/2-7-pauli-gadget}
\end{example}
